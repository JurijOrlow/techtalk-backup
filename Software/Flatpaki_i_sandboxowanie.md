# Co to jest Flatpak i dlaczego sandboxowanie aplikacji powinno być przyszłością software'u komputerowego?
## CZYLI WASZ ULUBIONY LINUXOWY ŚWIR ZNÓW PRZYCHODZI, ŻEBY WAS CZEGOŚ NAUCZYĆ I PRZY OKAZJI POMARUDZIĆ 😃
No dobra, ale od początku zaczynając. Zakładam z całkiem dużą dozą pewności, że znaczna większość z was posiada na swoim komputerze lub laptopie Windowsa. Zgaduję, że większość 10, niektórzy może jeszcze 7, inni już 11, ale to nie jest istotne. Rozchodzi się o coś innego.

Pobierzcie z internetu dowolny program - dajmy na to Gimpa. Zainstalujcie go, używajcie przez chwilę - otwórzcie jakieś zdjęcie, stwórzcie jakiś projekt, zapiszcie go i wyjdźcie. A teraz usuńcie Gimpa. Nic prostszego, wchodzimy w ustawienia, aplikację, dodaj/usuń programy, klikamy odinstaluj. Finito.

No nie do końca, bo cały ten proces ma kilka zasadniczych problemów, które postaram się wylistować:

1. Żeby zainstalować Gimpa potrzebowaliście pliku instalacyjnego. Nic prostszego, wchodzicie na stronę Gimpa i klikacie "Pobierz". Przeglądarka zapisuje wam w folderze "Pobrane" pliczek .exe i już jesteście gotowi do instalacji. Dwuklik i uruchamia się instalator. Jednak co jeśli strona Gimpa została shakowana? Ktoś wstawił zainfekowany wirusem plik na stronę? Zastanówcie się nad tym.

2. Podczas instalacji wybieramy miejsce instalacji. Albo i nie, bo obecnie sporo instalatorów ukrywa to za "Funkcjami zaawansowanymi", nawet nie pokazując użytkownikowi lokalizacji. Wszystko fajnie, dopóki nie musisz znaleźć folderu z tą aplikacją. Czy jest w Program Files? A może Program Files (x86)? A może po prostu tworzy osobny folder z nazwą aplikacji na dysku C? A może jeszcze jakoś inaczej, tworzy folder z nazwą firmy, a wewnątrz dopiero folder z nazwą aplikacji?

3. Podczas używania aplikacja zapisuje sobie na komputerze jakieś dane. Gdzie one są? Co to za dane? Jakie pliki? Tu wracamy do problemu numer 1, aplikacja ma dostęp do całego dysku i może bez problemu zapisać cokolwiek, gdziekolwiek (i nie, nie liczę wyskakującego okienka, pytającego czy zezwolić aplikacji na działanie jako administrator, bo realistycznie 99% użytkowników po prostu kliknie TAK)

4. I ostatnie - usuwamy aplikację. Czy usunęliśmy wszystko? A za cholerę, zostają śmieci w Dokumentach, w LocalLow, AppData, w rejestrze. Wydawać by się mogło niedużo, ale polecam eksperyment - uruchomić czystą wirtualkę z Windowsem 10, zainstalować z 10 aplikacji, od razu je odinstalować i porównać sobie ile jest wolnego miejsca na dysku. W teorii powinno być tyle samo, co do bita. A w rzeczywistości gdzieś nam megabajty znikają. Pomnóżcie to przez tysiące aplikacji, które zainstalujecie i usuniecie przez lata użytkowania komputera i już wiadomo czemu na Windowsie magicznie znika miejsce na dysku.

I jasne, wszystkie te problemy dla użytkownika technicznego nie są w ogóle problemami, przecież wiemy jak sobie z nimi radzić! Tylko że ilu nas, technicznych jest? 5%? 10? Reszta to zwykli użytkownicy, którzy nawet jak komputer im zwolni przez koparkę krypto to stwierdzą, że po prostu ten typ tak ma.
## I TU CAŁY NA BIAŁO WCHODZI LINUX ZE SWOIM SANDBOXOWANIEM!
No dobra, ale najpierw trzeba wyjaśnić czym jest sandboxowanie lub konteneryzacja aplikacji. Ci, którzy to wiedzą i z tym pracują - wybaczcie za koszmarne uproszczenia, możecie śmiało ten paragraf pominąć. Nic nie stracicie, a tylko pominiecie sekcję, która może was wkurzyć 😛

Więc tak, o aplikacjach sandboxowanych lub konteneryzowanych można pomyśleć jak o pakowaniu zestawów Lego do małych szczelnych, zamykanych na kłódeczkę pudełeczek i dopiero do skrzyni, zamiast wrzucania wszystkich elementów razem do jednej wielkiej skrzyni. Aplikacje, wszystkie ich zależności, wszystkie pliki, konfiguracje i całe hokus pokus, o których nawet się filologom nie śniło zostaje zamknięte w jednej lokalizacji, typowo w jednym folderze, z którego wydostać się mogą tylko i wyłącznie jeżeli użytkownik wyrazi świadomie taką chęć i wolę.

W naszej analogii do Lego byłoby to wyjmowanie ludzika z zestawu Gwiazdy Śmierci, żeby umieścić go na właśnie wybudowanym Sokole Millenium. I owszem, mając wszystko razem też możemy to zrobić, ba mniej jest z tym zachodu, po prostu grzebiemy i znajdujemy. Ale co, jeżeli mamy też zestawy z szarymi, ale nieco ciemniejszymi elementami? Albo figurkę Hana Solo w innym outficie, który nie pasuje do tego zestawu Sokoła Millenium i niechcący użyjemy tych elementów, bo wszystkie są razem? Nasi znajomi nas wyśmieją, pokazując że Sokół nie był tutaj ciemniejszy, a kieszeń Hana była w innym miejscu!

A tak na poważnie, sandboxowanie ma dwa główne cele - organizację i bezpieczeństwo. Po pierwsze wszystkie pliki są zamknięte w jednym folderze, jeżeli chcesz usunąć aplikację po prostu usuwasz ten folder i nie zostaje po niej żaden ślad. Tak, jakby nigdy jej tam nie było. Po drugie, nawet jeżeli aplikacja jakimś cudem zawierałaby wirusa, ten nie wydostanie się poza folder z tą aplikacją, chyba że świadomie mu na to pozwolisz.

Co ciekawe, to nie jest nowa technologia. Wszystkie aplikacje na Androida 10+ i iOS 12 lub 13+ są sandboxowane (dlatego np. musimy wyrażać zgodę na dostęp do plików czy kamery), a także aplikacje z Apple Store na MacOS są sandboxowane (nie, te z .dmg to już zupełnie inna kategoria i może kiedyś to opiszę). W zasadzie jedynym systemem, który się broni przed tą technologią jest Windows.
## WIEMY CO TO SANDBOXOWANIE. TO TERAZ CO TO TEN WSPOMNIANY FLATPAK?
Cóż, jest to jeden z dwóch głównych standardów sandboxowania dla Linuxa (a także dla ChromeOS, dzięki temu że ten używa jądra Linuxa), dla MacOS wsparcia na razie nie ma, chociaż coś tam zaczyna się o tym przebąkiwać. Flatpak jest rozwijany przez Fedora Project we współpracy z firmą Red Hat. Drugim standardem jest Snap, rozwijany przez Canonical (twórców Ubuntu) i używany tylko na Ubuntu. Nim nie będziemy się tu zajmować.

W ogromnym skrócie - developer (ale nie tylko, zwykły śmiertenik także) może dodać skrypt instalacji swojej aplikacji do Flathub, czyli wielkiego repozytorium aplikacji Flatpakowych. Wpis zawiera dane skąd pobrać kod źródłowy, co jest potrzebne do kompilacji i instalacji, jak wygląda struktura i wymagane do działania dostępy. Następnie zgłasza prośbę o dodanie, administratorzy Flathub przeglądają skrypt, upewniają się że nie ma tam żadnego złośliwego oprogramowania, że jest on kompatybilny z Flatpak Guidelines, nie narusza praw patentowych itd. Aplikacja jest dodawana do Flathuba, a stamtąd prosta droga do instalacji.

Na komputerze użytkownika zaś instalacja czegokolwiek w formie Flatpaka jest tak prosta, jak instalacja czegokolwiek na iOS/Android. Wchodzisz w menadżera oprogramowania twojej dystrybucji (czyli taki "Sklep z aplikacjami"), wyszukujesz aplikację, klikasz "Zainstaluj". I tyle. Flatpak automatycznie pobiera i zapisuje w jednej lokalizacji niezbędne zależności, tworzy "pudełeczko" dla aplikacji, ogranicza jej uprawnienia, dodaje skrót na pulpicie i wszystko gotowe. Żadnego działania jako administrator, żadnego wybierania miejsca. Wszystko jest w jednym, znanym miejscu i działa tylko tak, jak mu na to pozwolimy. Usuwanie też jest banalnie proste, menadżer oprogramowania po prostu usuwa folder z aplikacją i kropka. Tylko tyle i aż tyle. Wywala to konieczność nurkowania w sieć i szukania jakiś execów, licząc na to, że nie będą zainfekowane.
## TO SKORO TAK, TO CZEMU KAŻDY TEGO NIE UŻYWA? CZY NIE JEST TO IDEALNE ROZWIĄZANIE?
No niby tak. Ale ma swoje problemy. Przede wszystkim - paczki flatpakowe czasami są duże. Przykładem jest KCalc, zwykły kalkulator. Standardowo do pobrania jest 130 MB. Na nowej instalacji Fedory, Flatpak pobiera 900 MB by zainstalować KCalc. Ale już na mojej obecnej instalacji Fedory tylko 110 MB. O co chodzi?

Cóż, jak wspomniałem wyżej - Flatpak automatycznie pobiera i zapisuje zależności. Są to rzeczy takie jak biblioteki C, wersje Java, czcionki, rzeczy których aplikacja potrzebuje, ale nie są w niej zawarte. Jeżeli tych zależności nie ma na komputerze, Flatpak musi je pobrać i zapisać. Z drugiej jednak strony, pobiera je raz. To znaczy, że jeżeli pobieramy KCalc, który używa danej czcionki, a następnie pobierzemy aplikację, która także używa tej czcionki, Flatpak pominie tę zależność, ponieważ już masz ją na komputerze. Więc im mniej mamy aplikacji z Flatpaka, tym większe są rozmiary do pobrania. To akurat jest problem wszystkich aplikacji sandboxowanych.

Kolejną rzeczą są problemy wynikające z ograniczania dostępu do plików, które czasem mogą zdenerwować. Przykład, długo nie mogłem wyczaić, czemu QNapi, program do pobierania napisów, pokazywał że napisy pobrano, ale nie mogłem ich znaleźć. Okazało się, że program nie miał dostępu do katalogu, w którym miał te napisy zapisać. Z jednej strony to dobrze, dowodzi że sandboxy są bezpieczne. Z drugiej uświadomienie sobie, że to był problem zajęło mi upokarzająco dużo czasu.
Ostatnie - wydajność. Aplikacje sandboxowane mają typowo nieco większe zużycie RAMu niż aplikacje zwykłe. Wiąże się to z faktem, że pomiędzy pamięcią a aplikacją jest jeszcze cała "zapora" Flatpaka. Nie są to duże różnice, rzędu megabajtów, ale jednak są. Przez to nie wszystkie aplikacje da się zsandboxować, jak chociażby gry wideo.
## TO POWINNIŚMY UŻYWAĆ SANDBOXOWANIA, CZY NIE?!
Ależ oczywiście! Kurde, przecież praktycznie każdy telefon na świecie już używa tej technologii. Linuxy też praktycznie wszystkie, nawet MacOS poszedł w stronę sandboxowania. Lepsza organizacja plików, większe bezpieczeństwo. Problemy są, ale jestem pewien, że da się je obejść lub rozwiązać. Sandboxowanie powinno być przyszłością dystrybucji aplikacji.

Ale nie będzie. Dlaczego? Dlatego, że największy OS na świecie, Windows, ma sandboxowanie w trąbce. Schemat instalacji oprogramowania na Windowsie pozostaje ten sam jeszcze od czasów DOSa. Dosłownie NIC się nie zmieniło w tym aspekcie w Windowsie od prawie 30 lat i nie spodziewam się, by kiedykolwiek się zmieniło. Dlaczego tak jest? Cóż, można się tylko domyślać. Jeżeli ktoś wie, lub ma pomysł, to proszę o sugestie. Jeżeli nie, to myślę, że chyba czas zamykać ten temat.